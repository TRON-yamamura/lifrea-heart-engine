name: Lifrea Heart Engine (update)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # 毎時00分に自動実行

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Call Lifrea Heart Script
        uses: actions/github-script@v6
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
        script: |
            // 基準はUTCの現在時刻
            const nowUTC = new Date();

            // JST（UTC+9）は hour/weekday 計算だけに使う
            const jst = new Date(nowUTC.getTime() + 9 * 60 * 60 * 1000);

            const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];
            const weatherOptions = ['晴れ', '曇り', '雨', '雪'];
            const moodSeed = Math.random();

            const newPage = {
              parent: { database_id: process.env.NOTION_DATABASE_ID },
              properties: {
                title: { title: [{ text: { content: "GitHub Heartbeat" } }] },
                // ★ UTCのまま渡す（Notion側がJST表示に変換）
                time_iso: { date: { start: nowUTC.toISOString() } },

                // ★ JSTで計算して保存（22.7 = 22:42 など）
                hour: { number: jst.getHours() + jst.getMinutes() / 60 },

                // ★ JSTの曜日
                weekday: { select: { name: weekdayNames[jst.getDay()] } },

                weather: { select: { name: weatherOptions[Math.floor(Math.random()*weatherOptions.length)] } },
                temp_c: { number: 20 + Math.random() * 10 },
                mood_seed: { number: Math.round(moodSeed * 100) }
              }
            };

            const response = await fetch("https://api.notion.com/v1/pages", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.NOTION_TOKEN}`,
                "Content-Type": "application/json",
                "Notion-Version": "2022-06-28"
              },
              body: JSON.stringify(newPage)
            });

            if (!response.ok) {
              const errorData = await response.text();
              core.setFailed(`Notion API error: ${response.status} ${errorData}`);
            } else {
              core.info("✅ Notion entry created successfully (JST hour, UTC ISO)");
            }

