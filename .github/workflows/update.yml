name: Lifrea Heart Engine (update)
on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # 毎時0分（UTC）＝日本時間で毎時9分ごろ

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Call Lifrea Heart Script
        uses: actions/github-script@v6
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          WEATHER_CITY: "Tokyo"      # ← 必ず半角英字。都市名（例: Osaka, Kyoto もOK）
          WEATHER_COUNTRY: "JP"
        with:
          script: |
            const { NOTION_TOKEN, NOTION_DATABASE_ID, OPENWEATHER_API_KEY, WEATHER_CITY, WEATHER_COUNTRY } = process.env;

            const API_URL = `https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_CITY},${WEATHER_COUNTRY}&units=metric&appid=${OPENWEATHER_API_KEY}`;

            // === JST時間 ===
            const jst = new Date(Date.now() + 9 * 60 * 60 * 1000);
            const time_iso = jst.toISOString();
            const hour = jst.getHours() + jst.getMinutes() / 60;
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const weekday = weekdays[jst.getDay()];

            // === OpenWeatherから天気取得 ===
            const res = await fetch(API_URL);
            const weatherData = await res.json();

            if (!res.ok || !weatherData.main) {
              console.log("⚠️ OpenWeather API error or empty data:", weatherData);
              throw new Error("Weather data not available. Check city or API key.");
            }

            const temp_c = weatherData.main.temp ?? 0;
            const weatherMain = (weatherData.weather && weatherData.weather[0]?.main) || "Unknown";
            const weatherMap = {
              Clear: "晴れ",
              Clouds: "曇り",
              Rain: "雨",
              Snow: "雪",
              Drizzle: "霧雨",
              Thunderstorm: "雷",
              Mist: "霧",
              Haze: "靄",
              Fog: "霧",
              Smoke: "煙"
            };
            const weather = weatherMap[weatherMain] || "不明";

            const mood_seed = Math.floor(Math.random() * 100);

            const notionRes = await fetch("https://api.notion.com/v1/pages", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${NOTION_TOKEN}`,
                "Content-Type": "application/json",
                "Notion-Version": "2022-06-28"
              },
              body: JSON.stringify({
                parent: { database_id: NOTION_DATABASE_ID },
                properties: {
                  title: {
                    title: [{ text: { content: "GitHub Heartbeat" } }]
                  },
                  time_iso: { date: { start: time_iso } },
                  hour: { number: hour },
                  weekday: { select: { name: weekday } },
                  weather: { select: { name: weather } },
                  temp_c: { number: temp_c },
                  mood_seed: { number: mood_seed }
                }
              })
            });

            if (!notionRes.ok) {
              const err = await notionRes.text();
              throw new Error(`Notion API error: ${notionRes.status} ${err}`);
            }

            console.log("✅ Lifrea Heart Engine updated successfully (JST + Real Weather)");
