name: Lifrea Heart Engine (update)

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Call Lifrea Heart Script
        uses: actions/github-script@v6
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            // ---- build values ----
            const now = new Date();
            const weekdayNames = ['日','月','火','水','木','金','土'];
            const weekdayName = weekdayNames[now.getDay()];
            const hourNumber = now.getHours(); // 0-23
            const tempNumber = 22;             // ダミー値（後で好きに）
            const moodSeed  = Math.floor(Math.random()*100);

            // ---- create page ----
            const res = await fetch('https://api.notion.com/v1/pages', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.NOTION_TOKEN}`,
                'Notion-Version': '2022-06-28',
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                parent: { database_id: process.env.NOTION_DATABASE_ID },
                properties: {
                  title: {
                    title: [{ text: { content: 'GitHub Heartbeat' } }]
                  },
                  time_iso: { date: { start: now.toISOString() } },
                  hour:     { number: hourNumber },
                  // ← ここを select に修正
                  weekday:  { select: { name: weekdayName } },
                  weather:  { select: { name: '晴れ' } }, // DBに無ければ自動で追加されます
                  temp_c:   { number: tempNumber },
                  mood_seed:{ number: moodSeed }
                }
              })
            });

            const data = await res.json();
            if (!res.ok) {
              core.setFailed(`Notion API error: ${res.status} ${data.message || JSON.stringify(data)}`);
            } else {
              core.info('✅ Data successfully sent to Notion!');
            }
