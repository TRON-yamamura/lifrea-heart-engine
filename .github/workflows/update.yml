name: Lifrea Heart Engine (update)
on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Notion SDK ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm install @notionhq/client node-fetch@2

      # Lifrea Heart ã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè¡Œ
      - name: Call Lifrea Heart Script
        uses: actions/github-script@v6
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        with:
          script: |
            const { Client } = require("@notionhq/client");
            const fetch = require("node-fetch");

            const notion = new Client({ auth: process.env.NOTION_TOKEN });
            const databaseId = process.env.NOTION_DATABASE_ID;

            // JSTæ™‚é–“
            const now = new Date();
            const jstOffset = 9 * 60 * 60 * 1000;
            const jstNow = new Date(now.getTime() + jstOffset);

            const timeISO = jstNow.toISOString();
            const hour = jstNow.getHours() + jstNow.getMinutes() / 60;
            const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
            const weekday = weekdays[jstNow.getDay()];

            // åå¤å±‹ã®å¤©æ°—
            const city = "Nagoya,JP";
            const apiKey = process.env.OPENWEATHER_API_KEY;
            const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=ja`;

            console.log("ğŸŒ Fetching weather for:", city);
            const res = await fetch(weatherUrl);
            const weatherData = await res.json();

            if (res.status !== 200) {
              console.log("âš ï¸ OpenWeather API error:", weatherData);
              throw new Error(`Weather API failed: ${res.status} ${weatherData.message}`);
            }

            const weather = weatherData.weather[0].description;
            const temp_c = weatherData.main.temp;
            const mood_seed = Math.floor(Math.random() * 101);

            console.log("ğŸ•’ JST Time:", timeISO);
            console.log("ğŸŒ¡ï¸ Temp:", temp_c);
            console.log("â˜ï¸ Weather:", weather);
            console.log("ğŸ’— Mood:", mood_seed);

            await notion.pages.create({
              parent: { database_id: databaseId },
              properties: {
                title: { title: [{ text: { content: "GitHub Heartbeat" } }] },
                time_iso: { date: { start: timeISO } },
                hour: { number: hour },
                weekday: { select: { name: weekday } },
                weather: { select: { name: weather } },
                temp_c: { number: temp_c },
                mood_seed: { number: mood_seed },
              },
            });

            console.log("âœ… Successfully updated Notion!");
